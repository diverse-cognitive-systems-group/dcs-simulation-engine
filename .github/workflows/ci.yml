name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10.13"
      - name: Install Poetry
        run: pipx install "poetry==2.1.4"
      - name: Install deps (incl. dev)
        run: poetry install --with dev --no-interaction
      - run: make lint

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10.13"
      - name: Install Poetry
        run: pipx install "poetry==2.1.4"
      - name: Install deps (incl. dev)
        run: poetry install --with dev --no-interaction
      - run: make test

  build-docs:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: pipx install "poetry==2.1.4"
      - name: Install deps (incl. dev)
        run: poetry install --with dev --no-interaction
      - run: make docs
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-docs:
    # only deploy on push to main (not PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build-docs
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  # TODO: uncomment when demo launch is ready to make live
  # deploy-demo:
  #   # only deploy on push to main (not PRs)
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   needs: test
  #   runs-on: ubuntu-latest
  #   env:
  #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  #     PRIMARY_REGION: dfw
  #     GAME: ${{ github.event.inputs.game_name }}
  #     BANNER: ${{ github.event.inputs.banner }}
  #     PORT: ${{ github.event.inputs.port }}
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: superfly/flyctl-actions/setup-flyctl@master

  #     - name: Build fly config from inputs
  #       run: |
  #         cat > fly.generated.toml <<'TOML'
  #         app = 'simulation-widget-${{ github.event.inputs.experiment_id }}'
  #         primary_region = '${{ env.PRIMARY_REGION }}'

  #         [build]

  #         [processes]
  #           web = 'poetry run python -m scripts.run_widget --source "simulation-widget-${{ github.event.inputs.experiment_id }}" --game ${{ env.GAME }} --port ${{ env.PORT }} --host 0.0.0.0 --banner "$${{ env.BANNER }}"'

  #         [http_service]
  #           internal_port = ${{ env.PORT }}
  #           force_https = true
  #           auto_stop_machines = 'stop'
  #           auto_start_machines = true
  #           min_machines_running = 0
  #           processes = ['web']

  #         [[vm]]
  #           memory = '1gb'
  #           cpu_kind = 'shared'
  #           cpus = 1
  #         TOML
  #     - name: Launch or attach to Fly app
  #       run: |
  #         if flyctl apps list | grep -q "simulation-widget-${{ github.event.inputs.experiment_id }}"; then
  #           echo "App exists, skipping creation."
  #         else
  #           flyctl apps create simulation-widget-${{ github.event.inputs.experiment_id }} --org personal --yes
  #         fi
  #     - name: Deploy
  #       run: |
  #         flyctl deploy \
  #           --remote-only \
  #           --config fly.generated.toml \
  #           --ha=false \
  #           --app "${FLY_APP}" \
  #           --env MONGO_URI="${{ secrets.MONGO_URI }}" \
  #           --env OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \

  # TODO: uncomment when release tags are ready
    # build-and-publish-package:
    # runs-on: ubuntu-latest

    # steps:
    #   - name: Check out code
    #     uses: actions/checkout@v4

    #   - name: Set up Python
    #     uses: actions/setup-python@v5
    #     with:
    #       python-version: "3.11"

    #   - name: Install Poetry
    #     run: |
    #       pip install --upgrade pip
    #       pip install poetry

    #   - name: Install dependencies
    #     run: poetry install --no-root

    #   - name: Run tests
    #     run: poetry run pytest

    #   - name: Build package
    #     run: poetry build

    #   - name: Publish to PyPI
    #     env:
    #       PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
    #     run: |
    #       poetry config pypi-token.pypi "$PYPI_API_TOKEN"
    #       poetry publish